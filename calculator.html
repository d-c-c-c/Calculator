<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="calculator.css">
    <title>Calculator</title>

  
</head>
<body>
    <div class="CalculatorContainer">
        <!-- The display of the calculator at the top -->
        <div class="calculatorDisplay">0</div> 

        <!-- This is where all of the keys will go -->
        <div class="calculatorKeys">
            <button class="keyExpression" data-action="t"><span></span></button>
            <button class="keyExpression" data-action="t"><span></span></button>
            <button class="keyExpression" data-action="t"><span>e</span></button>
            <button class="keyExpression" data-action="t"><span>&pi;</span></button>

            <button class="keyOperator" data-action="add"><span>+</span></button>
            <button class="keyOperator" data-action="subtract"><span>-</span></button>
            <button class="keyOperator" data-action="multiply"><span>&times;</span></button>
            <button class="keyOperator" data-action="divide"><span>&divide;</span></button>

            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
    
            <button><span>7</span></button>
            <button><span>8</span></button>
            <button><span>9</span></button>

            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>

            <button><span>4</span></button>
            <button><span>5</span></button>
            <button><span>6</span></button>

            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>

            <button><span>1</span></button>
            <button><span>2</span></button>
            <button><span>3</span></button>
            

            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button><span>0</span></button>
            

            
            <button id= "decimalButton" data-action="decimal"><span>.</span></button>
            <button id= "clearButton" data-action="clear"><span>AC</span></button>
            <button class="keyEqual" data-action="calculate"><span>=</span></button>
        </div>


    </div>

      <!-- Javascript Code -->
      <script>

        const calculator = document.querySelector('.CalculatorContainer');
        const keys = calculator.querySelector('.calculatorKeys');
        const display = document.querySelector('.calculatorDisplay')
       
        // TODO: Make a separate function for expressions like exponents, sin cos tan, log, etc
        // Call it 'calculateExpression' --> calculateExpression(num, expression(?), num2 == optional) (in the case of exponents)
        //rename 'calculate to calculateOperation' --> calculateOperation(num1, operation, num2)

        //Evaluate the input expression
        const calculate = (num1, operator, num2) => {
            const firstNum = parseFloat(num1)
            const secondNum = parseFloat(num2)
            const result = performCalc(num1, operator, num2)

            // Check if the number is very large; If it is, return the number formatted in scientific notation
            return isLargeNumber(result) ? result.toExponential(2) : result;
        }
            
        //
        const performCalc = (num1, operator, num2) => {
            switch (operator) {
            case 'add':
                return num1 + num2
            case 'subtract':
                return num1 - num2
            case 'multiply':
                return num1 * num2
            case 'divide': 
                return num1 / num2
            default:
                return NaN
            }
        }

        // Check if the calculation result is a very large number
        const isLargeNumber = (num) => {
            const threshold = 1e12 //arbitrary threshold for a large number
            return Math.abs(num) >= threshold
        }
        // Returns the type of key that the user clicked
        const getKeyType = (key) => {
            const { action } = key.dataset

            //if key is a number 
            if (!action) return 'number'

            //if key is an operator
            if (
                action === 'add' ||
                action === 'subtract' ||
                action === 'multiply' ||
                action === 'divide'
            ) return 'operator'
            // for any other key, return the action
            return action
        }
        // Splitting event listener into pure and impure functions

        // Returns the result of the calculator operation to the display screen
        // key: content of the clicked key
        // displayedNumber: content currently displayed on the calculator screen
        // state: shorthand variable for calculator.dataset. Used to to determine the data action for the clicked key, if it has one
        const createResultString = (key, displayedNum, state) => {
            const keyContent = key.textContent
            const keyType = getKeyType(key)
            const {
                firstValue,
                operator,
                modValue,
                previousKeyType
            } = state

            if (keyType === 'number') {
                return displayedNum === '0' ||
                previousKeyType === 'operator' ||
                previousKeyType === 'calculate'
                ? keyContent
                : displayedNum + keyContent
            }

            if (keyType === 'decimal') {
                if (!displayedNum.includes('.')) return displayedNum + '.'
                if (previousKeyType === 'operator' || previousKeyType === 'calculate') return '0.'
                return displayedNum
            }

            if (keyType === 'operator') {
                return firstValue &&
                operator &&
                previousKeyType !== 'operator' &&
                previousKeyType !== 'calculate'
                ? calculate(firstValue, operator, displayedNum)
                : displayedNum
            }

            if (keyType === 'clear') return 0

            if (keyType === 'calculate') {
                return firstValue
                ? previousKeyType === 'calculate'
                    ? calculate(displayedNum, operator, modValue)
                    : calculate(firstValue, operator, displayedNum)
                : displayedNum
            }
        }
    
        //Updates the calculator state based on the clicked key
        const updateCalculatorState = (key, calculator, calculatedValue, displayedNum) => {
            const keyType = getKeyType(key)
            const {
                firstValue,
                operator,
                modValue,
                previousKeyType
            } = calculator.dataset

            calculator.dataset.previousKeyType = keyType
            console.log(keyType)
            console.log(firstValue, operator, modValue)

            if (keyType === 'operator') {
                calculator.dataset.operator = key.dataset.action
                calculator.dataset.firstValue = firstValue &&
                operator &&
                previousKeyType !== 'operator' &&
                previousKeyType !== 'calculate'
                ? calculatedValue
                : calculatedValue
            }

            if (keyType === 'calculate') {
                calculator.dataset.modValue = firstValue && previousKeyType === 'calculate'
                ? modValue
                : calculatedValue
            }

            if (keyType === 'clear') {
                calculator.dataset.firstValue = ''
                calculator.dataset.modValue = ''
                calculator.dataset.operator = ''
                calculator.dataset.previousKeyType = ''
            }
        }

        const updateVisualState = (key, calculator) => {
            const keyType = getKeyType(key)
            Array.from(key.parentNode.children).forEach(k => k.classList.remove('is-depressed'))

            if (keyType === 'operator') key.classList.add('is-depressed')
            if (keyType === 'clear' && key.textContent !== 'AC') {
                const clearButton = calculator.querySelector('[data-action=clear]')
                clearButton.getElementsByTagName("span")[0].textContent = 'AC'
            }
            if (keyType !== 'clear') {
                const clearButton = calculator.querySelector('[data-action=clear]')
                clearButton.getElementsByTagName("span")[0].textContent = 'CE'
            }
        }
        // Event listener
        keys.addEventListener('click', e => {
            if (e.target.matches('button')) {

            console.log(e.target)
            const key = e.target
            const displayedNumber = display.textContent
            const resultString = createResultString(key, displayedNumber, calculator.dataset)

            display.textContent = resultString
            console.log(resultString)
            updateCalculatorState(key, calculator, resultString, displayedNumber)
            updateVisualState(key,calculator)

            }

        });

    </script>
</body>
</html>