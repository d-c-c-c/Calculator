<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="calculator.css">
    <title>Calculator</title>

  
</head>
<body>
    <div class="CalculatorContainer">
        <!-- The display of the calculator at the top -->
        <div class="calculatorDisplay">0</div> 

        <!-- This is where all of the keys will go -->
        <div class="calculatorKeys">
            <button class="keyExpression" data-action="t"><span></span></button>
            <button class="keyExpression" data-action="t"><span></span></button>
            <button class="specialNums"><span>e</span></button>
            <button class="specialNums"><span>&pi;</span></button>

            <button class="keyOperator" data-action="add"><span>+</span></button>
            <button class="keyOperator" data-action="subtract"><span>-</span></button>
            <button class="keyOperator" data-action="multiply"><span>&times;</span></button>
            <button class="keyOperator" data-action="divide"><span>&divide;</span></button>

            <button class="keyExponent" data-action="x2"><span>x<sup>2</sup></span></button>
            <button class="keyExponent" data-action="x3"><span>x<sup>3</sup></button>
            <button class="keyOperator" data-action="xy"><span>x<sup>y</sup></button>
            <button class="keyExponent" data-action="ex"><span>e<sup>x</sup></button>
    
            <button><span>7</span></button>
            <button><span>8</span></button>
            <button><span>9</span></button>

            <button class="keyExponent" data-action="10x"><span>10<sup>x</sup></button>
            <button class="keyExpression" data-action="t"><span>sin()</span></button>
            <button class="keyExpression" data-action="t"><span>cos()</span></button>
            <button class="keyExpression" data-action="t"><span>tan()</span></button>

            <button><span>4</span></button>
            <button><span>5</span></button>
            <button><span>6</span></button>

            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>

            <button><span>1</span></button>
            <button><span>2</span></button>
            <button><span>3</span></button>
            

            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button class="keyExpression" data-action="t"><span>test</span></button>
            <button><span>0</span></button>
            

            
            <button id= "decimalButton" data-action="decimal"><span>.</span></button>
            <button id= "clearButton" data-action="clear"><span>AC</span></button>
            <button class="keyEqual" data-action="calculate"><span>=</span></button>
        </div>


    </div>

      <!-- Javascript Code -->
      <script>

        const calculator = document.querySelector('.CalculatorContainer');
        const keys = calculator.querySelector('.calculatorKeys');
        const display = document.querySelector('.calculatorDisplay')
       
        // TODO: Make a separate function for expressions like exponents, sin cos tan, log, etc

        //Evaluate the input exponent
        

        // Calculate operations using the standard four operators
        const calculateOperation = (num1, operator, num2) => {
            const firstNum = parseFloat(num1)
            const secondNum = parseFloat(num2)
            const result = performCalc(firstNum, operator, secondNum)

            // Check if the number is very large; If it is, return the number formatted in scientific notation
            return isLargeNumber(result) ? result.toExponential(2) : result;
        }

        const calculateExponent = (num1, expression, num2) => {
            const firstNum = parseFloat(num1)
            const secondNum = parseFloat(num2)
            const result = performExp(firstNum, expression, secondNum)
            return isLargeNumber(result) ? result.toExponential(2) : result;
        }
            
        const performCalc = (num1, operator, num2) => {
            switch (operator) {
            case 'add':
                return parseFloat(num1) + parseFloat(num2);
            case 'subtract':
                return num1 - num2;
            case 'multiply':
                return num1 * num2;
            case 'divide': 
                return num1 / num2;
            case 'xy': 
                return Math.pow(num1, num2);
            default:
                return NaN;
            }
        }

        performExp = (num1, expression, num2) => {
            switch(expression) {
                case 'x2':
                    return Math.pow(num1, 2);
                case 'x3':
                    return Math.pow(num1, 3);
                case 'ex': 
                    return Math.pow(Math.E, num1);
                case '10x': 
                    return Math.pow(10, num1);
                default: 
                    return NaN;
            }
        }

        // Check if the calculation result is a very large number
        const isLargeNumber = (num) => {
            const threshold = 1e12 //arbitrary threshold for a large number
            return Math.abs(num) >= threshold
        }
        // Returns the type of key that the user clicked
        const getKeyType = (key) => {
            const { action } = key.dataset

            //if key is a number 
            if (!action) return 'number'

            //if key is an operator
            if (
                action === 'add' ||
                action === 'subtract' ||
                action === 'multiply' ||
                action === 'divide' ||
                action === 'xy'
            ) return 'operator'

            if (
                action === 'x2' ||
                action === 'x3' ||
                //action === 'xy' ||
                action === 'ex' ||
                action === '10x'
            ) return 'exponent'
            // for any other key, return the action
            return action
        }
        // Splitting event listener into pure and impure functions

        // Returns the result of the calculator operation to the display screen
        // key: content of the clicked key
        // displayedNumber: content currently displayed on the calculator screen
        // state: shorthand variable for calculator.dataset. Used to to determine the data action for the clicked key, if it has one
        const createResultString = (key, displayedNum, state) => {
            const keyContent = key.textContent
            const keyType = getKeyType(key)
            const {
                firstValue,
                operator,
                modValue,
                previousKeyType
            } = state
            // console.log(keyType)
            // console.log(keyContent)
            
            if (keyType === 'number') {
                if (displayedNum === '0' ||
                previousKeyType === 'operator' ||
                previousKeyType === 'calculate' ||
                previousKeyType === 'exponent'
                ){
                    if (keyContent === 'e') {
                        return Math.E.toString()
                    }

                    if (keyContent === 'π') {
                        return Math.PI
                    }                   
                    return keyContent
                } else {
                    return keyContent === 'e' || keyContent === 'π'
                    ?  displayedNum
                    : displayedNum + keyContent
                }
            }

            if (keyType === 'decimal') {
                if (!displayedNum.includes('.')) return displayedNum + '.'
                if (previousKeyType === 'operator' || previousKeyType === 'calculate') return '0.'
                return displayedNum
            }

            if (keyType === 'operator') {
                //state.operator = ''
                console.log('current key type:', keyType)
                console.log("previous key type:",previousKeyType)
                console.log('state operator', operator)
                console.log('first value:', firstValue)
                console.log(firstValue, operator, displayedNum)
                if (firstValue &&
                operator &&
                previousKeyType !== 'operator' &&
                previousKeyType !== 'calculate' &&
                previousKeyType !== 'exponent') {
                    return calculateOperation(firstValue, operator, displayedNum)
                } else {
                    return displayedNum
                }
            }
            
            //TODO: Get exponents to work when chaining operators together
            // Check for bugs when clicking x2 -> calculate, seems to produce NaN
            if (keyType === 'exponent') {
                state.operator = key.dataset.action
                console.log(operator)
                if (state.operator === 'xy') {
                    console.log('first value:',firstValue)
                    if (firstValue) {
                        console.log(firstValue,state.operator,displayedNum)
                        return calculateExponent(firstValue, state.operator, displayedNum)
                    } else {
                        return displayedNum
                    }
                } else {
                    return calculateExponent(displayedNum, state.operator)
                } 
            }

            if (keyType === 'clear') return 0

            if (keyType === 'calculate') {
                if (firstValue) {
                    if (previousKeyType === 'calculate') {
                        if (state.operator === 'xy') {
                            return calculateExponent(displayedNum, state.operator, modValue)
                        } else {
                            return calculateOperation(displayedNum, operator, modValue)
                        }
                    } else {
                        if (state.operator === 'xy') {
                            return calculateExponent(firstValue, state.operator, displayedNum)
                        } else {
                            return calculateOperation(firstValue, operator, displayedNum)
                        }
                    }
                } else {
                    console.log('w')
                    return displayedNum
                }
            }
        }
    
        //Updates the calculator state based on the clicked key
        const updateCalculatorState = (key, calculator, calculatedValue, displayedNum) => {
            const keyType = getKeyType(key)
            const {
                firstValue,
                operator,
                modValue,
                previousKeyType
            } = calculator.dataset

            calculator.dataset.previousKeyType = keyType
            

            if (keyType === 'operator' || keyType === 'exponent') {
                calculator.dataset.operator = key.dataset.action
                calculator.dataset.firstValue = firstValue &&
                operator &&
                previousKeyType !== 'operator' &&
                previousKeyType !== 'calculate' 
                ? calculatedValue
                : displayedNum
            }

            if (keyType === 'exponent') {
                calculator.dataset.operator = key.dataset.action
                calculator.dataset.firstValue = firstValue &&
                operator &&
                previousKeyType !== 'operator'
                ? calculatedValue
                : displayedNum
            }

            if (keyType === 'calculate' || keyType === 'exponent') {
                calculator.dataset.modValue = firstValue && (previousKeyType === 'calculate' || previousKeyType === 'exponent')
                ? modValue
                : displayedNum
            }

            if (keyType === 'clear') {
                calculator.dataset.firstValue = ''
                calculator.dataset.modValue = ''
                calculator.dataset.operator = ''
                calculator.dataset.previousKeyType = ''
            }
        }

        const updateVisualState = (key, calculator) => {
            const keyType = getKeyType(key)
            Array.from(key.parentNode.children).forEach(k => k.classList.remove('is-depressed'))

            if (keyType === 'operator') key.classList.add('is-depressed')

            if (keyType === 'exponent' && calculator.dataset.operator === 'xy') {
                key.classList.add('is-depressed')
            }
            if (keyType === 'clear' && key.textContent !== 'AC') {
                const clearButton = calculator.querySelector('[data-action=clear]')
                clearButton.getElementsByTagName("span")[0].textContent = 'AC'
            }
            if (keyType !== 'clear') {
                const clearButton = calculator.querySelector('[data-action=clear]')
                clearButton.getElementsByTagName("span")[0].textContent = 'CE'
            }
        }
        // Event listener
        keys.addEventListener('click', e => {
            if (e.target.matches('button')) {

            const key = e.target
            const displayedNumber = display.textContent
            const resultString = createResultString(key, displayedNumber, calculator.dataset)

            display.textContent = resultString
            updateCalculatorState(key, calculator, resultString, displayedNumber)
            updateVisualState(key,calculator)

            }

        });

    </script>
</body>
</html>